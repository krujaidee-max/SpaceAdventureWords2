<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>เกม : ตะลุยอวกาศ คำเป็น-คำตาย</title>
<style>
/* ===== ฟอนต์รวมหน้า ===== */
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNew.woff2') format('woff2'),
       url('image/THSarabunNew.woff') format('woff'),
       url('image/THSarabunNew.ttf') format('truetype');
  font-weight: 400; font-style: normal; font-display: swap;
}
@font-face{
  font-family: 'MyGameFont';
  src: url('image/THSarabunNewBold.woff2') format('woff2'),
       url('image/THSarabunNewBold.woff') format('woff'),
       url('image/THSarabunNewBold.ttf') format('truetype');
  font-weight: 700; font-style: normal; font-display: swap;
}
html, body, button, input, select, textarea, .pill, .btn, .btn-mini,
.levelBtn, #startTitle, #countdown, .label, #timer {
  font-family: 'MyGameFont', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif;
}

/* ===== ธีมพื้นฐาน + พื้นหลังชุดอุกกาบาต ===== */
:root{ --glass: rgba(0,0,0,.45); --ok:#10b981; --bad:#ef4444; }
*{ box-sizing:border-box }
html,body{ height:100%; margin:0; }
body{
  background: url("image/background2.png") center center / cover no-repeat fixed !important;
  overflow:hidden; color:#fff;
}
#game{ position:relative; width:100vw; height:100vh; overflow:hidden }

/* === offsets สำหรับคะแนนและอุกกาบาต === */
:root{
  --score-offset-x: -27px;   /* + ขวา / - ซ้าย */
  --score-offset-y: 6px;    /* + ลง  / - ขึ้น */
  --comet-offset-x: 100px;   /* เลื่อนอุกกาบาตแกน X */
  --comet-offset-y: 60px;    /* เลื่อนอุกกาบาตแกน Y */

  /* ✅ ตัวแปรใหม่ ขยับตัวจับเวลา */
  --timer-offset-x: -32px;     /* + ขวา / - ซ้าย */
  --timer-offset-y: 8px;     /* + ลง  / - ขึ้น */
}

/* ขยับ pill “คะแนน” เฉพาะอันเดียว */
#scorePill{ transform: translate(var(--score-offset-x), var(--score-offset-y)); }
/* ขยับ pill “ตัวจับเวลา” */
#timer{
  transform: translate(var(--timer-offset-x), var(--timer-offset-y));
}


/* ===== HUD ===== */
.hud{
  position:fixed; inset:26px 12px auto 38px;
  display:flex; align-items:center; gap:12px; justify-content:space-between; pointer-events:none
}
.hud .left,.hud .right{ display:flex; align-items:center; gap:12px }
.pill{ background:var(--glass); backdrop-filter:blur(6px); padding:8px 12px; border-radius:999px; box-shadow:0 4px 18px rgba(0,0,0,.25) }
#timer{ font-weight:700; font-variant-numeric:tabular-nums; letter-spacing:.5px; font-size:20px }
.icon img{ width:44px; height:44px; object-fit:contain; filter:drop-shadow(0 4px 10px rgba(0,0,0,.6)); border-radius:8px }
.stack{ display:flex; flex-direction:column; gap:8px; align-items:flex-start }
.btn-mini{ pointer-events:auto; background:#1f2937; color:#fff; border:none; border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer; box-shadow:0 4px 18px rgba(0,0,0,.25) }
.btn-mini:hover{ filter:brightness(1.1) }

/* ===== จัด HUD ฝั่งขวาให้ชิดขวา + แถวล่างเรียงบน→ล่าง ===== */
.hud .right { align-items: flex-end; }
.hud .right .stack { align-items: flex-end; }
.hud .right .col{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
.hud .right .pill{ text-align:right; }

/* ===== หน้าจอเริ่ม (ภารกิจ + นับถอยหลัง) ===== */
#startScreen{
  position:fixed; inset:0; display:none;
  flex-direction:column; align-items:center; justify-content:center;
  background:rgba(0,0,0,.9); z-index:9999; text-align:center; padding:24px
}
#startTitle{ font-size:clamp(26px,5vw,48px); font-weight:900; margin-bottom:10px }
#startBtn{
  margin-top:12px; padding:10px 18px; border:0; border-radius:12px; font-weight:800; cursor:pointer; background:#1f2937; color:#fff
}
#startBtn:hover{ filter:brightness(1.1) }
#countdown{ display:none; font-size:clamp(56px,12vw,120px); font-weight:1000; line-height:1; margin-top:8px }

/* ===== Landing: เลือกด่าน + คู่มือ ===== */
#landing{
  position: fixed; inset: 0;
  display: flex; flex-direction: column; gap: 22px;
  align-items: center; justify-content: center;
  background: url("image/background2.png") center/cover no-repeat fixed !important;
  z-index: 20000; transition: opacity .3s ease;
}
#landing.hide{ opacity: 0; pointer-events: none; visibility: hidden; }
#landing .brand{ width: min(92vw, 1100px); }
#landing .brand img{ width:100%; height:auto; display:block; filter:drop-shadow(0 10px 30px rgba(0,0,0,.6)); }
.level-menu{ display:flex; flex-direction:column; gap:14px; width:min(92vw, 640px); }
.levelBtn{
  width:100%; padding: 10px 16px;
  font-size: clamp(20px, 4vw, 34px); font-weight: 1000; letter-spacing:.2px;
  border: 0; border-radius: 14px; color: #fff; background: rgba(0,0,0,.55);
  box-shadow: 0 10px 28px rgba(0,0,0,.35); cursor: pointer; text-align:center;
  border:1px solid rgba(255,255,255,.18); backdrop-filter: blur(6px);
}
.levelBtn:hover{ filter: brightness(1.08); }
.levelBtn:active{ transform: translateY(1px); }

/* ===== คู่มือ ===== */
#guideScreen{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:url("image/background2.png") center/cover no-repeat;
  z-index: 20001;
}
#guideScreen .guide-wrap{
  width:min(95vw, 1200px);
  max-height:92vh;
  display:flex; flex-direction:column; gap:10px;
  align-items:center; justify-content:center;
}
#guideScreen img{
  width:100%; height:auto; max-height:92vh;
  border-radius:14px;
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  display:block;
}
#guideScreen .guide-close{
  align-self:flex-end; margin-top:8px;
  background:#1f2937; color:#fff; border:none; border-radius:12px; padding:8px 12px; font-weight:800; cursor:pointer;
}
#guideScreen .guide-close:hover{ filter:brightness(1.1) }

/* ===== ป๊อปอัปจบเกม ===== */
#overlay{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.55); visibility:hidden; opacity:0; transition:.25s; z-index:9999 }
#overlay.show{ visibility:visible; opacity:1 }
.panel{ background:rgba(20,20,20,.9); border:1px solid rgba(255,255,255,.1); padding:22px 26px; border-radius:20px; min-width:320px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,.5) }
.panel h1{ margin:0 0 6px; font-size:28px }
.panel p{ margin:8px 0 18px; opacity:.85 }
.btn{ background:#1f2937; color:#fff; border:none; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer }
.btn:hover{ filter:brightness(1.1) }
.actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
#overlay .btn { padding: 12px 24px; font-size: 20px; font-weight: 900; border-radius: 18px; min-width: 180px; }
#restartBtn { background:#1f2937; } #restartBtn:hover{ filter:brightness(1.1) }
#selectLevelBtn { background:#2563eb; } #selectLevelBtn:hover{ background:#1d4ed8 }
#nextLevelBtn { background:#10b981; } #nextLevelBtn:hover{ background:#059669 }
.wrong-box{ margin-top:14px; text-align:left; display:none; }
.wrong-title{ font-weight:900; font-size:30px; margin-bottom:8px }
.wrong-list{ display:flex; flex-wrap:wrap; gap:8px; max-height:140px; font-size:28px; overflow:auto }
.chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:999px; font-weight:700 }
.muted{ opacity:.7 }

/* ===== ปุ่มลอยคะแนน +/- ===== */
.float{ position:fixed; left:0; top:0; pointer-events:none; font-weight:800; font-size:24px; text-shadow:0 2px 8px rgba(0,0,0,.5) }
@keyframes rise{ 0%{ transform:translate(-50%,-10px); opacity:0 } 15%{ opacity:1 } 100%{ transform:translate(-50%,-70px); opacity:0 } }

/* ===== เรืออวกาศ ===== */
#ship{
  position:fixed;
  left:50%; bottom:-45px;
  width:280px; height:280px;
  background:url("image/ship.png") center/contain no-repeat;
  transform:translateX(-50%) rotate(0deg);
  transform-origin:50% 75%;
  pointer-events:none;
  z-index:8001;
}

/* ===== อุกาบาต ===== */
.comet{
  position:absolute; top:-160px;
  width:var(--size,110px); height:var(--size,110px);
  background-image:url("image/comet.png");
  background-size:100% 100%; background-repeat:no-repeat;
  filter:drop-shadow(0 6px 12px rgba(0,0,0,.45));
  cursor:crosshair; user-select:none; will-change:transform,opacity;
}
.comet .label{
  position:absolute; inset:0; display:grid; place-items:center;
  font-weight:800; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.8);
  font-size: calc(var(--size) / 5); pointer-events:none;
}
.comet.fast{
  filter:
     drop-shadow(0 10px 22px rgba(0,0,0,.6));
}
.piece{
  position:fixed; width:14px; height:14px; opacity:1; pointer-events:none;
  background-image:url("image/comet.png"); background-repeat:no-repeat;
  background-size:var(--csizeW) var(--csizeH);
}
@keyframes blast{ to{ transform:translate(var(--dx),var(--dy)) rotate(var(--rot)); opacity:0 } }

/* (ซ่อน kid/acceptBox เดิม) */
#kid, #acceptBox { display:none !important; }

@media (max-width:480px){
  #timer{ font-size:20px }
}

/* ให้ HUD ลอยสูงกว่า landing (20000) */
/* HUD ต้องอยู่หลัง Landing */
.hud{
  z-index: 15000; /* น้อยกว่า landing (20000) แต่ยังสูงกว่าเกม (3) */
}

/* ปุ่มลอย mute / fullscreen ให้อยู่กับ HUD */
#muteBtn, #fsBtn{
  z-index: 15000 !important;
}

/* ===== มุมขวา-บน: button2 ===== */
/* ===== มุมซ้ายบน: button1 ===== */
body::after{
  content:"";
  position: fixed;
  top: 0; left: 0;
  width: var(--corner-img-w, 220px);
  height: var(--corner-img-h, 220px);
  background: url("image/button1.png") no-repeat left top / contain;
  pointer-events: none;
  z-index: 10000;  /* > 3 (game), < 22001 (HUD) */
}

/* ===== มุมขวาบน: button2 ===== */
body::before{
  content:"";
  position: fixed;
  top: 0; right: 0;
  width: var(--corner2-img-w, 200px);
  height: var(--corner2-img-h, 200px);
  background: url("image/button2.png") no-repeat right top / contain;
  pointer-events: none;
  z-index: 10000;  /* ให้เท่ากันกับ button1 */
}

/* ซ่อนไอคอนรูปอุกกาบาตข้างคะแนน */
.hud .right .icon { display: none !important; }

/* ==== กล้องแบบกระจก + แคนวาสวาด overlay ==== */
#cameraMirror{
  position:fixed; inset:0;
  width:100vw; height:100vh;
  object-fit:cover;
  transform: scaleX(-1);
  z-index: 1;
  display:none;
  background:#000;
}
#camCanvas{
  position:fixed; inset:0;
  width:100vw; height:100vh;
  z-index: 2;
  pointer-events:none;
  display:none;
}
/* ให้เลเยอร์สนามเกมอยู่เหนือวิดีโอแน่ ๆ */
#game{ z-index: 3; position:relative; }

/* เอฟเฟกต์แตกกระจาย + คะแนนลอย ให้อยู่สูงพอ */
.float{ z-index: 21500; }
.piece{ z-index: 21500; }
</style>
</head>
<body>
<!-- ==== AR Mirror ==== -->
<video id="cameraMirror" playsinline muted></video>
<canvas id="camCanvas"></canvas>

<div id="game" aria-label="สนามเกม">
  <div id="kid" aria-hidden="true">
    <div id="acceptBox"><div class="txt" id="ruleLabel">ภารกิจ</div></div>
  </div>
</div>

<!-- ===== Landing ===== -->
<div id="landing" role="dialog" aria-modal="true">
  <div class="brand"><img src="image/banner2.png" alt="Banner"></div>
  <div class="level-menu">
    <button class="levelBtn" data-level="0">ด่านที่ 1 : คำเป็น</button>
    <button class="levelBtn" data-level="1">ด่านที่ 2 : คำตาย</button>
    <button class="levelBtn" id="guideBtn">กติกาการเล่น 📖</button>
  </div>
</div>

<!-- ===== ภารกิจ / หน้าเริ่ม ===== -->
<div id="startScreen">
  <div id="startTitle">ภารกิจ: ยิงคำเป้าหมายให้ได้ “คะแนนสูงสุด” ภายในเวลา</div>
  <button id="startBtn">เริ่ม</button>
  <div id="countdown">3</div>
</div>

<!-- ===== คู่มือ ===== -->
<div id="guideScreen">
  <div class="guide-wrap">
    <img src="image/guide.png" alt="คู่มือเกม">
    <button id="guideBack" class="btn-mini guide-close">เมนูหลัก</button>
  </div>
</div>

<!-- ===== HUD ===== -->
<div class="hud">
  <div class="left">
    <div class="stack">
      <!-- (เอา timer ออกจากฝั่งซ้าย) -->
      <div style="display:flex; gap:8px;">
        <button id="pauseBtn" class="btn-mini">⏸ หยุด</button>
        <button id="quickRestart" class="btn-mini">หน้าหลัก</button>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="micBtn" class="btn-mini" title="เปิด/ปิด ระบบสั่งเสียง">🎤: ปิด</button>
        <div id="voicePill" class="pill" style="display:none;">กำลังฟัง…</div>
        <button id="camBtn" class="btn-mini" title="เปิด/ปิด กล้อง AR">📷: ปิด</button>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="stack" style="align-items:flex-end">
      <!-- ✅ ตัวจับเวลา ย้ายขึ้นมุมขวาบน เหนือคะแนน -->
      <div class="pill" id="timer">02:00</div>

      <div style="display:flex; gap:8px; align-items:center;">
        <div class="icon pill" style="padding:4px 8px">
          <img src="image/comet.png" alt="comet">
        </div>
        <div class="pill" id="scorePill">คะแนน: <span id="score">0</span></div>
      </div>
    </div>
  </div>
</div>


<!-- ===== ยาน ===== -->
<div id="ship" aria-hidden="true"></div>

<!-- ===== ป๊อปอัปจบเกม ===== -->
<div id="overlay">
  <div class="panel">
    <h1 id="endTitle">หมดเวลา!</h1>
    <p>คะแนนสุดท้าย: <b id="finalScore">0</b></p>
    <p id="accumSummary" style="display:none; color:#ffd700; font-weight:900;">
      คะแนนสะสมรวม (3 รอบ): <b id="accumTotal">0</b>
    </p>
    <div class="wrong-box">
      <div class="wrong-title">คำที่ยิงพลาด</div>
      <div id="wrongList" class="wrong-list"></div>
    </div>
    <div class="actions">
      <button class="btn" id="restartBtn">เริ่มใหม่</button>
      <button class="btn" id="selectLevelBtn">เลือกด่าน</button>
      <button class="btn" id="nextLevelBtn">ด่านถัดไป</button>
    </div>
  </div>
</div>

<!-- ===== เสียง ===== -->
<audio id="hitSound" preload="auto"></audio>
<audio id="winSound" preload="auto"></audio>
<audio id="bgm" preload="auto" loop></audio>

<!-- ===== ปุ่ม Mute / Fullscreen ===== -->
<button id="muteBtn" aria-pressed="false" title="Mute / Unmute"
  style="position:fixed; right:12px; bottom:12px; width:44px; height:44px; border-radius:999px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.3); color:#fff; font-size:18px; line-height:1; display:grid; place-items:center; cursor:pointer; z-index:10000;">🔊</button>

<button id="fsBtn" aria-pressed="false" title="เข้าสู่โหมดเต็มจอ"
  style="position:fixed; right:12px; bottom:62px; width:44px; height:44px; border-radius:999px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.3); color:#fff; font-size:18px; line-height:1; display:grid; place-items:center; cursor:pointer; z-index:10000;">⛶</button>

<!-- ===== ควบคุม Mute ===== -->
<script>
(function(){
  const muteBtn = document.getElementById('muteBtn');
  if(!muteBtn) return;
  let isMuted = false;
  function applyMute(m){
    isMuted = !!m;
    document.querySelectorAll('audio').forEach(a => {
      a.muted = isMuted;
      if(isMuted){ a.setAttribute('muted',''); } else { a.removeAttribute('muted'); }
    });

  window.__AUDIO__ = window.__AUDIO__ || {};
  window.__AUDIO__.muted = isMuted;
    muteBtn.setAttribute('aria-pressed', String(isMuted));
    muteBtn.textContent = isMuted ? '🔇' : '🔊';
  }
  muteBtn.addEventListener('click', () => applyMute(!isMuted));
})();
</script>

  <script>
/* ===== Audio unlock + shared mute state ===== */
(function(){
  // โครงเก็บสถานะเสียงแบบแชร์ทั่วหน้า
  window.__AUDIO__ = window.__AUDIO__ || { muted:false, unlocked:false };

  // ซิงก์สถานะเริ่มต้นจาก <audio> ที่มีในหน้า
  function syncFromDOM(){
    const any = document.querySelector('audio');
    window.__AUDIO__.muted = !!(any && any.muted);
  }
  syncFromDOM();

  // ปลดล็อกเสียง (เรียกตอนมีการคลิกของผู้ใช้)
  window.__AUDIO__.unlock = async function unlockAudio(){
    if (window.__AUDIO__.unlocked) return;
    try{
      const a = document.getElementById('hitSound');
      if (a){
        const wasPaused = a.paused;
        const prevTime = a.currentTime;
        a.volume = 0.01;              // เบา ๆ เพื่อแค่กระตุ้นระบบเสียง
        await a.play().catch(()=>{});
        a.pause();
        a.currentTime = prevTime;
        if(!wasPaused){ a.play().catch(()=>{}); }
      }
      window.__AUDIO__.unlocked = true;
    }catch(_){}
  };

  // จับคลิกใด ๆ บนหน้าจอ → ลองปลดล็อกเสียง + อัปเดตสถานะ
  document.addEventListener('click', () => {
    window.__AUDIO__?.unlock?.();
    syncFromDOM();
  }, {capture:true});
})();
</script>

<!-- ===== ควบคุม Fullscreen ===== -->
<script>
(function(){
  const fsBtn = document.getElementById('fsBtn');
  if (!fsBtn) return;

  function fsEnabled(){
    return document.fullscreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled;
  }
  function isFull(){
    return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
  }
  function requestFS(){
    const el = document.documentElement;
    const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
    req && req.call(el);
  }
  function exitFS(){
    const ex = document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen;
    ex && ex.call(document);
  }
  function render(){
    const on = !!isFull();
    fsBtn.setAttribute('aria-pressed', String(on));
    fsBtn.title = on ? 'ออกจากโหมดเต็มจอ' : 'เข้าสู่โหมดเต็มจอ';
    fsBtn.textContent = on ? '🗗' : '⛶';
  }

  if (!fsEnabled()){
    fsBtn.style.display = 'none';
    return;
  }

  fsBtn.addEventListener('click', () => {
    if (isFull()) exitFS(); else requestFS();
  });

  document.addEventListener('fullscreenchange', render);
  document.addEventListener('webkitfullscreenchange', render);
  document.addEventListener('msfullscreenchange', render);
  render();
})();
</script>

<!-- ===== ระบบเกม ===== -->
<script>
(() => {
  /* ---------- DOM refs ---------- */
  const game = document.getElementById('game');
  const timerEl = document.getElementById('timer');
  const overlay = document.getElementById('overlay');
  const endTitleEl = document.getElementById('endTitle');
  const finalScoreEl = document.getElementById('finalScore');
  const restartBtn = document.getElementById('restartBtn');
  const quickRestart = document.getElementById('quickRestart');
  const selectLevelBtn = document.getElementById('selectLevelBtn');
  const nextLevelBtn = document.getElementById('nextLevelBtn');
  const wrongListEl = document.getElementById('wrongList');
  const wrongBoxEl = document.querySelector('.wrong-box');

  const scoreEl = document.getElementById('score');

  const hitSound = document.getElementById('hitSound');
  const winSound = document.getElementById('winSound');
  const bgm = document.getElementById('bgm');

  if (hitSound) { hitSound.src = "image/audio1.mp3"; hitSound.volume = 0.8; }
  if (winSound) { winSound.src = "image/win2.mp3";  winSound.volume = 1.0; }
  if (bgm)      { bgm.src = "image/bgm3.mp3";       bgm.volume = 0.35; }

  /* ---------- ชุดคำ: คำเป็น คำตาย ---------- */
  const NOUNS = [ "ครู","นักเรียน","หมอ","ตำรวจ","ทหาร","พ่อค้า","แม่ค้า","คนสวน","ชาวนา","ชาวประมง",
"กิน","คน","น้ำตาล","การบ้าน","เพื่อน","นอน","เข็มขัด","รางวัล","บันได","สัญจร","สัญญาณ","ประมาณ","พยาบาล",
"ปลาวาฬ","จาน","เขียน","ต้นไม้","บ้าน","บิน","ดิน","ก้อนหิน","สวน","เรียน","ลม","ชม","คม","นม","อม","น้ำส้ม","ผม","ชมรม",
"มอมแมม","กลม","ถม","ขม","จม","คำ","ทำ","น้ำ","ชาม","ความดี","ห้าม","สาม","งาม","เสมอ","สมควร","ศาล","สมาคม","สมบูรณ์",
"สมอง","สนาม","ขาย","ควาย","ตาย","ยาย","นาย","ผู้ชาย","ท้ายทอย","ล่องลอย","รอคอย","ถอยหลัง","สร้อย","น้อย","ร้อยเรียง","อ้อย","อร่อย","ช่วย",
"ป่วย","เมื่อย","เฉื่อย","เรื่อย","เปื่อย","เรื่อยเปื่อย","ฉลุย","ปุ๋ย","กล้วยหอม","สวยงาม","ร่ำรวย","ข้าว","กาว","ดวงดาว","สาว","ก้าวร้าว","กล่าว",
"ฉาว","ข่าวสาร","แวววาว","ผิวพรรณ","คิ้ว","นิ้ว","ลิ่วล้อ","ริ้วรอย","เร็ว","เที่ยว","คนเลว","เผา","เหา","เมามาย","ปลิว","หิวโหย","เกี่ยว","หาว","ร้าวราน","วี่แวว",
"แนว","แถว","คงคา","จงใจ","ทรง","เพลง","ลง","งง","สรงน้ำ","ส่งของ","ฟัง","ฝัง","ผัง","พังเพย","ย่าง","มารดา",
"ราชา","มาลา","นาที","ภาษา","ราตรี","อาสา","ลอยแพ","ราคี","ราศี","ภารโรง","โรตี","แปล","เรือใบ","ปลาทู","สามี","นาวี","โศกา",
"ชีวี","มาลี","กวี","เวหา","ชีวา","ไกล่เกลี่ย","ลีลา","ศรี","พรั่งพรู","สิงโต","มือถือ","ถือศีล","ตื่นนอน","ต้นไทร","ถือตัว","มือเปล่า","ตุ่ม",
"งูเขียว","ปลาร้า","หู","ปูนา","ชู้","ข่มขู่","ข่มเหง","รังแก","โมโห","โลมา","โอชา","โลเล","โกดัง","โกงกาง","เก้ง","สมบูรณ์","โคมไฟ",
"คอหอย","ปลาช่อน","ก่อไฟ","บ่อน้ำ","ปราชัย","หมอน","คอ","หัวข้อ","ตอม่อ","คอหมูย่าง","เสมอ","สมอ","เผอเรอ","เผลอใจ",
"อ่อนเพลีย","เพ้อเจ้อ","สหาย","ทนาย","ควายป่า","เกเร","ทะเล","เวลา","เสน่ห์","ฉลาม","เฉลย","เมนู","เยาว์วัย","ทราย","เฉลิม",
"แพร่หลาย","แม่นยำ","แกงส้ม","สว่าง","โกรธา","แมงมุม","พลั่ว","เกลือ","ผลีผลาม","เสียใจ","เสียหาย","เสียดาย","เรียนรู้","อู่","สมาน",
"เหลือเฟือ","เรื่องราว","เสือโคร่ง","เมื่อคืน","กล้ามเนื้อ","เนื้อหนัง","สวนครัว","มั่วสุม","กล้วยหอม"
];
  const VERBS = [ "ตกยาก","ยก","นก","รัก","ปลั๊ก","พัก","ผัก","หลัก","หักศอก","อยาก","มาก","บอก","หอก","ดอกจิก","ออก","จิกกัด","แปลกแยก","เปียก",
"เรียก","ลูก","เผือก","เลือก","เปลือก","โรค","โชค","เมฆหมอก","เลข","ปักหลัก","ปลูก","ปลอก","ปอก","พรรค","สมัคร",
"สุข","กระบอก","กระดูก","กบ","จบ","ครบ","จอบ","หมอบ","รอบคอบ","สวัสดิ์","หอบ","ตบ","รับ","เกียรติบัตร","ขับ","ตวาด","หลับ","ตลก",
"อวบ","ปราบ","ดาบ","ทราบ","กับดัก","รูปภาพ","ภพชาติ","ภาพ","กราฟ","สวิตช์","โกรธ","ประจบ","เปรียบเทียบ","สิทธิ","ประทับ","ประกบ",
"ประกาศ","ทาส","รับทราบ","ประจักษ์","ประสบ","กด","กัด","จัด","วัด","ประสาท","เกียรติยศ","การ์ด","กฎ","รถ","รสชาติ",
"บวช","ทิศ","อุปสรรค","มิตร","คณิตศาสตร์","สัตวแพทย์","พิศวาส","อิฐ","อูฐ","แตกดับ","กระดก","ประจวบ","ประทัด","บทบาท","ปราศจาก","นิราศ","บริษัท","พุทธ","ผลิต","สนิท","ก๊าซ",
"กะทิ","มะระ","กะปิ","เยอะแยะ","เป็ด","มะระ","มะลิ","เสด็จ","กระแดะ","ชนะ","โต๊ะ","ปะทะ","ระเบิด","กระตุก","ตะขบ","ประวัติ","เงาะ","มะขวิด",
"กระจุก","เหมาะ","ปะทุ","สติ","ซุบซิบ","ประหยัด","เพชร","ศิริ","ระงับ","ทะเลาะ","แกะ","กระโดด","มะกรูด","เกาะ","กระจก","พลุ",
"หีบ","สะดุด","สลัด","ฉลาด","กระดาษ","รถ","บัตร","กระเจี๊ยบ","สะกิด","ตะกละ","ชะมด","ประเสริฐ","กระจิริด","จมูก","ประณีต","อุปโลกน์","ขยะ",
"ระนาด","ตะกุกตะกัก","กระจิ๊ดริด","พยัคฆ์","พิษ","กิจ","สุข","ทุกข์","บริจาค","โรค","ปลดแอก","แขก","ทรัพย์","อนุญาต","นาค",
"พืช","กอล์ฟ","ตะเกียบ","พริก","ลุมุด","สระ","สลบ","ยุทธศาสตร์","ครุฑ","กริช","ประมาท","หมัก","อริ","ทศวรรษ","ครุ","ระยะ","ปะทุ",
"เหนอะหนะ","มนุษย์","หลบหลัก","ละเมาะ","แกะ","แพะ","กวาด","ทวีป","หมัด","เบส","กระโหลก"
];

  const LEVELS = [
    { id:0, name:"ด่าน 1", mission:"ภารกิจ : ยิงอุกกาบาต “คำเป็น” ให้มากที่สุด", correct:NOUNS, wrong:[...VERBS] },
    { id:1, name:"ด่าน 2", mission:"ภารกิจ : ยิงอุกกาบาต “คำตาย” ให้มากที่สุด", correct:VERBS, wrong:[...NOUNS] },
  ];
  let selectedLevel = 0;

  /* ---------- คะแนนสะสม = 3 รอบ ---------- */
  let cumulativeScore = 0;
  let roundsPlayed   = 0;
  let lastRunScore   = 0;

  function updateAccum(){
    const el = document.getElementById('accumVal');
    if(el) el.textContent = cumulativeScore.toString();
  }
  function refreshNextButton(){
    const sumEl = document.getElementById('accumSummary');
    const totalEl = document.getElementById('accumTotal');
    if (roundsPlayed < 1){
      nextLevelBtn.disabled = false; nextLevelBtn.textContent = 'ด่านถัดไป'; nextLevelBtn.style.opacity = '1';
      if(sumEl) sumEl.style.display = 'none';
      return;
    }
    if (roundsPlayed === 1){
      nextLevelBtn.disabled = false; nextLevelBtn.textContent = 'สรุปคะแนนสะสม'; nextLevelBtn.style.opacity = '1';
      if(sumEl) sumEl.style.display = 'none';
      return;
    }
    nextLevelBtn.disabled = true; nextLevelBtn.textContent = 'ครบ 2 รอบแล้ว'; nextLevelBtn.style.opacity = '0.6';
    if (sumEl && totalEl){ totalEl.textContent = cumulativeScore.toString(); sumEl.style.display = 'block'; }
  }

  /* ---------- เกมอุกกาบาต ---------- */
  const stageSeconds = 120;
  const MAX_COMETS = 3;
  const SPAWN_MS = 120;
  const SPEED_MIN = 100, SPEED_MAX = 260;
  const VX_MAX = 140;
  const PROB_CORRECT = 0.40;

  const FAST_VY = 220;
  const CORRECT_NORMAL = 1;
  const CORRECT_FAST   = 2;
  const WRONG_NORMAL   = -1;
  const WRONG_FAST     = -2;
  const PASS_SCORE = 20;

  let running = false, ended = false, paused = false;
  let spawner = null, countdown = null;
  let remain = stageSeconds;
  let lastTime = 0;

  let score = 0;
  let clickedWrongWords = [];

  function fmt(sec){
    const m = Math.floor(sec/60).toString().padStart(2,'0');
    const s = (sec%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }
  function floatText(text, x, y, kind){
    const t = document.createElement('div');
    t.className = 'float'; t.textContent = text;
    t.style.left = x+'px'; t.style.top = y+'px';
    t.style.color = (kind==='ok') ? 'var(--ok)' : 'var(--bad)';
    t.style.animation = 'rise 800ms ease-out forwards';
    document.body.appendChild(t);
    t.addEventListener('animationend', () => t.remove(), {once:true});
  }
  function rand(min,max){return Math.random()*(max-min)+min}
  function randInt(min,max){return Math.floor(rand(min,max+1))}

 function playHit(){
  try {
    // เคารพ mute กลาง
    if (window.__AUDIO__ && window.__AUDIO__.muted) return;

    const base = hitSound;
    if (!base || !base.src) return;

    // ใช้ instance เดิมก่อน (ลดโอกาสโดน policy)
    if (base.paused) {
      base.currentTime = 0;
      base.volume = 1;
      base.muted = false;
      base.play().catch(()=>{});
      return;
    }

    // ต้องซ้อนเสียง → ใช้ clone แต่ "ใส่ DOM ชั่วคราว"
    const a = base.cloneNode(true);
    a.src = base.src;
    a.volume = 1;
    a.muted = false;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.play().catch(()=>{}).finally(()=>{
      setTimeout(()=>a.remove(), 1500);
    });
  } catch(e){}
}


  let correctDeck = [], wrongDeck = [];
  let seenRound = new Set();

  function shuffleInPlace(arr){
    for(let i = arr.length - 1; i > 0; i--){
      const j = (Math.random() * (i + 1)) | 0;
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function resetDecksForLevel(){
    const L = LEVELS[selectedLevel] || LEVELS[0];
    correctDeck = shuffleInPlace(L.correct.slice());
    wrongDeck   = shuffleInPlace(L.wrong.slice());
    seenRound.clear();
  }
  function drawUnique(fromCorrect){
    const L = LEVELS[selectedLevel] || LEVELS[0];
    let deck = fromCorrect ? correctDeck : wrongDeck;
    let guard = L.correct.length + L.wrong.length + 5;
    while (guard-- > 0){
      if (deck.length === 0){
        if (fromCorrect){ correctDeck = shuffleInPlace(L.correct.slice()); deck = correctDeck; }
        else            { wrongDeck   = shuffleInPlace(L.wrong.slice());   deck = wrongDeck;   }
      }
      const word = deck.pop();
      if (!seenRound.has(word)){
        seenRound.add(word);
        return word;
      }
    }
    return fromCorrect ? (L.correct[0] || '') : (L.wrong[0] || '');
  }

  function hitComet(node, atX, atY){
    if(!node || !running) return;
    if(node.dataset.hit) return;
    node.dataset.hit = '1';

    const val  = node.dataset.value === '1';
    const fast = node.dataset.fast  === '1';

    let delta = 0;
    if (val){
      delta = fast ? CORRECT_FAST : CORRECT_NORMAL;
      score += delta;
      scoreEl.textContent = score;
      floatText('+'+delta + (fast?' ⚡':''), atX, atY, 'ok');
    }else{
      delta = fast ? WRONG_FAST : WRONG_NORMAL;
      score += delta;
      scoreEl.textContent = score;
      const text = node.querySelector('.label')?.textContent?.trim();
      if(text) clickedWrongWords.push(text);
      floatText(delta.toString(), atX, atY, 'bad');
    }

    if (score >= PASS_SCORE) { endGame('win'); }
    try { window.__GAME__?.pointShipToNode?.(node); } catch(e){}
    shatter(node);
    playHit();
  }

  function spawnComet(){
    if(!running) return;
    if(document.querySelectorAll('.comet').length >= MAX_COMETS) return;

    const size = randInt(220, 320);
    const vy   = rand(SPEED_MIN, SPEED_MAX);
    const vx   = [ -1, 0, 1 ][randInt(0,2)] * rand(40, VX_MAX);
    const startX = randInt(0, Math.max(20, window.innerWidth - size - 20));
    const startY = -size - 40;

    const node = document.createElement('div');
    node.className = 'comet';
    node.style.setProperty('--size', size+'px');
    node.style.left = '0px'; node.style.top = '0px';

    const isFast = vy >= FAST_VY;
    node.dataset.fast = isFast ? '1' : '0';
    if(isFast) node.classList.add('fast');

    const isCorrect = Math.random() < PROB_CORRECT;
    const label = document.createElement('div');
    label.className = 'label';
    if (isCorrect){
      label.textContent = drawUnique(true);
      node.dataset.value = '1';
    } else {
      label.textContent = drawUnique(false);
      node.dataset.value = '0';
    }

    node.dataset.x = startX; node.dataset.y = startY;
    node.dataset.vx = vx;    node.dataset.vy = vy;

    node.appendChild(label);

    node.addEventListener('click', (ev) => {
      if(!running) return;
      if(node.dataset.hit) return;
      const r = node.getBoundingClientRect();
      hitComet(
        node,
        ev.clientX ?? (r.left + r.width/2),
        ev.clientY ?? (r.top + r.height/2)
      );
    }, { once:true });

    game.appendChild(node);
    node.style.transform = `translate(calc(${startX}px + var(--comet-offset-x)),
                             calc(${startY}px + var(--comet-offset-y)))`;
  }

  function shatter(cometEl){
  const rect = cometEl.getBoundingClientRect();
  cometEl.style.opacity = '0';
  cometEl.style.pointerEvents = 'none';
  setTimeout(() => cometEl.remove(), 180);

  // ===== ปรับคุณภาพเอฟเฟกต์ =====
  const PIECE_MIN   = 22;   // ขนาดชิ้นขั้นต่ำ (ใหญ่ขึ้น = จำนวนน้อยลง)
  const PIECE_DIV   = 4;    // เดิม ~6 → ใช้ 4 เพื่อลดจำนวนชิ้น
  const MAX_PIECES  = (document.getElementById('cameraMirror')?.style.display === 'block') ? 70 : 110;

  // ระยะกระจายใกล้ขึ้น (เดิม ~1.2*width)
  const SPREAD_K    = 0.55; // 0.45–0.65 กำลังดี
  // ช้าลงนิดหน่อย (ถ้าไม่อยากช้า ให้ลดช่วงเวลา)
  const DUR_MIN_MS  = 900;
  const DUR_MAX_MS  = 1400;

  const piece = Math.max(PIECE_MIN, Math.floor(rect.width / PIECE_DIV));
  const cols  = Math.ceil(rect.width  / piece);
  const rows  = Math.ceil(rect.height / piece);

  let made = 0;
  for (let ry = 0; ry < rows; ry++){
    for (let rx = 0; rx < cols; rx++){
      if (made >= MAX_PIECES) break;

      const p = document.createElement('div');
      p.className = 'piece';
      p.style.setProperty('--csizeW', rect.width  + 'px');
      p.style.setProperty('--csizeH', rect.height + 'px');
      p.style.left   = (rect.left + rx*piece) + 'px';
      p.style.top    = (rect.top  + ry*piece) + 'px';
      p.style.width  = piece + 'px';
      p.style.height = piece + 'px';
      p.style.backgroundPosition = `-${rx*piece}px -${ry*piece}px`;

      const spread = Math.max(80, rect.width * SPREAD_K);
      const dx = (rx - cols/2 + (Math.random() - .5)) * spread;
      const dy = (ry - rows/2 + (Math.random() - .5)) * spread - 20;
      const rot = (Math.random()*160 - 80) + 'deg';
      p.style.setProperty('--dx',  dx + 'px');
      p.style.setProperty('--dy',  dy + 'px');
      p.style.setProperty('--rot', rot);

      const dur = Math.random() * (DUR_MAX_MS - DUR_MIN_MS) + DUR_MIN_MS;
      p.style.willChange = 'transform, opacity';
      p.style.animation  = `blast ${dur}ms ease-out forwards`;

      document.body.appendChild(p);
      p.addEventListener('animationend', () => p.remove(), { once:true });
      made++;
    }
  }
}


  function tick(now){
    const dt = Math.min(0.05, (now - lastTime)/1000);
    lastTime = now;

    document.querySelectorAll('.comet').forEach(node => {
      let x = parseFloat(node.dataset.x)||0;
      let y = parseFloat(node.dataset.y)||0;
      const vx = parseFloat(node.dataset.vx)||0;
      const vy = parseFloat(node.dataset.vy)||0;
      x += vx * dt; y += vy * dt;
      node.dataset.x = x; node.dataset.y = y;
      node.style.transform = `translate(calc(${x}px + var(--comet-offset-x)),
                                 calc(${y}px + var(--comet-offset-y)))`;

      const size = parseFloat(getComputedStyle(node).getPropertyValue('--size'))||100;
      if(y > window.innerHeight + size*1.5 || x < -size*1.5 || x > window.innerWidth + size*1.5){
        node.remove();
      }
    });

    if(running) requestAnimationFrame(tick);
  }

  function clearScene(){
    [...document.querySelectorAll('.comet,.piece,.float')].forEach(el => el.remove());
  }

  function startGame(){
    running = true; ended = false; paused = false;
    overlay.classList.remove('show');

    score = 0; scoreEl.textContent = score;
    lastRunScore = 0;
    resetDecksForLevel();

    clickedWrongWords = [];
    if (wrongListEl) wrongListEl.innerHTML = '';
    if (wrongBoxEl)  wrongBoxEl.style.display = 'none';

    try{ if(bgm){ bgm.currentTime = 0; bgm.play().catch(()=>{}); } }catch(e){}

    remain = stageSeconds; timerEl.textContent = fmt(remain);
    if(countdown) clearInterval(countdown);
    countdown = setInterval(() => {
      if(!running) return;
      remain--; timerEl.textContent = fmt(remain);
      if(remain <= 0){ endGame('time'); }
    }, 1000);

    if(spawner) clearInterval(spawner);
    spawner = setInterval(spawnComet, SPAWN_MS);

    lastTime = performance.now();
    requestAnimationFrame(tick);
  }

  function endGame(reason='time'){
    if(ended) return;
    ended = true; running = false;
    clearInterval(countdown);
    clearInterval(spawner);

    lastRunScore = score;
    finalScoreEl.textContent = score.toString();
    endTitleEl.textContent = (reason==='win') ? 'เก่งมาก! ผ่านด่าน 🎉' : 'หมดเวลา!';

    if (wrongListEl){
      if (clickedWrongWords.length === 0){
        if (wrongBoxEl) wrongBoxEl.style.display = 'none';
      } else {
        const seen = new Set();
        const unique = clickedWrongWords.filter(w => (seen.has(w) ? false : (seen.add(w), true)));
        wrongListEl.innerHTML = unique.map(w => `<span class="chip">${w}</span>`).join('');
        if (wrongBoxEl) wrongBoxEl.style.display = 'block';
      }
    }

    try{ if (winSound) { winSound.currentTime = 0; winSound.play().catch(()=>{}); } }catch(e){}
    try{ if(bgm){ bgm.pause(); bgm.currentTime = 0; } }catch(e){}

    overlay.classList.add('show');
  }

  function pauseGame(){
    if (!running) return;
    paused = true;
    running = false;
    clearInterval(countdown);
    clearInterval(spawner);
    try { if (bgm) bgm.pause(); } catch(e){}
    const pauseBtn = document.getElementById('pauseBtn');
    if (pauseBtn) pauseBtn.textContent = '▶️ ต่อ';
  }

  function resumeGame(){
    if (!paused || ended) return;
    paused = false;
    running = true;
    lastTime = performance.now();
    countdown = setInterval(() => {
      if(!running) return;
      remain--;
      timerEl.textContent = fmt(remain);
      if(remain <= 0){ endGame('time'); }
    }, 1000);
    spawner = setInterval(spawnComet, SPAWN_MS);
    requestAnimationFrame(tick);
    try { if (bgm) bgm.play().catch(()=>{}); } catch(e){}
    const pauseBtn = document.getElementById('pauseBtn');
    if (pauseBtn) pauseBtn.textContent = '⏸ หยุด';
  }

  const pauseBtn = document.getElementById('pauseBtn');
  if(pauseBtn){
    pauseBtn.addEventListener('click', ()=>{
      if(!paused){ pauseGame(); pauseBtn.textContent = '▶️ ต่อ'; }
      else{ resumeGame(); pauseBtn.textContent = '⏸ หยุด'; }
    });
  }

  let wasRunningBeforeHide = false;
  function uiBlockingOpen(){
    const landing = document.getElementById('landing');
    const startScreen = document.getElementById('startScreen');
    const guide = document.getElementById('guideScreen');
    const overlayOpen = overlay && overlay.classList.contains('show');
    const landingOpen = landing && !landing.classList.contains('hide');
    const startOpen   = startScreen && startScreen.style.display !== 'none';
    const guideOpen   = guide && getComputedStyle(guide).display !== 'none';
    return overlayOpen || landingOpen || startOpen || guideOpen;
  }
  function handleHidden(){
    wasRunningBeforeHide = running && !ended && !uiBlockingOpen();
    if (wasRunningBeforeHide) pauseGame();
  }
  function handleVisible(){
    if (wasRunningBeforeHide && paused && !ended && !uiBlockingOpen()){
      resumeGame();
    }
    wasRunningBeforeHide = false;
  }
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) handleHidden(); else handleVisible();
  });
  window.addEventListener('blur', handleHidden);
  window.addEventListener('focus', handleVisible);
  window.addEventListener('pagehide', handleHidden);
  window.addEventListener('pageshow', handleVisible);

  const quickHome = document.getElementById('quickRestart');
  if(quickHome){ quickHome.addEventListener('click', ()=>{ location.reload(); }); }

  restartBtn.addEventListener('click', () => { clearScene(); startGame(); });

  selectLevelBtn.addEventListener('click', () => {
    overlay.classList.remove('show');
    clearScene();
    cumulativeScore = 0; roundsPlayed = 0; lastRunScore = 0; updateAccum();
    const landing = document.getElementById('landing');
    const startScreen = document.getElementById('startScreen');
    if (landing){ landing.classList.remove('hide'); }
    if (startScreen){ startScreen.style.display = 'none'; }
  });

  nextLevelBtn.addEventListener('click', () => {
    if (roundsPlayed < 1) {
  cumulativeScore += lastRunScore; roundsPlayed++; updateAccum();
  selectedLevel = (selectedLevel + 1) % LEVELS.length;
  overlay.classList.remove('show');
  openStartForLevel(true);
  return;
}
if (roundsPlayed === 1) {
  cumulativeScore += lastRunScore; roundsPlayed++; updateAccum();
  const sumEl = document.getElementById('accumSummary');
  const totalEl = document.getElementById('accumTotal');
  if (sumEl && totalEl){ totalEl.textContent = cumulativeScore.toString(); sumEl.style.display = 'block'; }
  endTitleEl.textContent = 'สรุปคะแนนสะสม (2 รอบ)';
  finalScoreEl.textContent = lastRunScore.toString();
  refreshNextButton();
  return;
}
  });

  window.__GAME__ = {
    startGame,
    setSelectedLevel: (i)=>{ selectedLevel = i|0; },
    getLevel: (i)=> LEVELS[i],
    getMissionFor: (i)=> (LEVELS[i] && LEVELS[i].mission) ? LEVELS[i].mission : '',
    hitComet
  };

  (function(){
    const ship = document.getElementById('ship');
    if(!ship) return;
    const SHIP_OFFSET_DEG = 90;
    function rotateTo(x, y){
      const r = ship.getBoundingClientRect();
      const pivotX = r.left + r.width  * 0.5;
      const pivotY = r.top  + r.height * 0.75;
      const dx = x - pivotX, dy = y - pivotY;
      const deg = Math.atan2(dy, dx) * 180 / Math.PI;
      ship.style.transform = `translateX(-50%) rotate(${deg + SHIP_OFFSET_DEG}deg)`;
    }
    document.addEventListener('mousemove', (e) => rotateTo(e.clientX, e.clientY));
    rotateTo(window.innerWidth/2, window.innerHeight/2);

    window.__GAME__ = window.__GAME__ || {};
    window.__GAME__.pointShipAt = rotateTo;
    window.__GAME__.pointShipToNode = (el) => {
      if(!el) return;
      const rc = el.getBoundingClientRect();
      rotateTo(rc.left + rc.width/2, rc.top + rc.height/2);
    };
  })();

  const startScreen  = document.getElementById('startScreen');
  const startTitle   = document.getElementById('startTitle');
  const startBtn     = document.getElementById('startBtn');
  const countdownEl  = document.getElementById('countdown');

  function openStartForLevel(autoCountdown = true){
    const L = LEVELS[selectedLevel];
    if(startTitle){
      startTitle.textContent = (L.mission || `ภารกิจ: ${L.name}`);
    }
    if(startScreen) startScreen.style.display = 'flex';
    if(startBtn) startBtn.style.display = 'none';
    if(!autoCountdown) return;

    if(countdownEl){
      let n = 3;
      countdownEl.textContent = n; countdownEl.style.display = 'block';
      const itv = setInterval(() => {
        n--;
        if(n>0){ countdownEl.textContent = n; }
        else{
          clearInterval(itv);
          if(startScreen) startScreen.style.display = 'none';
          startGame();
        }
      }, 1000);
    }
  }

  if(startBtn){
    startBtn.addEventListener('click', () => {
      window.__AUDIO__?.unlock?.();
      startBtn.style.display = 'none';
      let n = 3; countdownEl.textContent = n; countdownEl.style.display = 'block';
      const itv = setInterval(() => {
        n--;
        if(n>0){ countdownEl.textContent = n; }
        else{ clearInterval(itv); startScreen.style.display = 'none'; startGame(); }
      }, 1000);
    }, { once:true });
  }

  (function(){
    const landing     = document.getElementById('landing');
    const levelBtns   = document.querySelectorAll('.levelBtn');
    const startScreen = document.getElementById('startScreen');
    const startTitle  = document.getElementById('startTitle');

    levelBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        window.__AUDIO__?.unlock?.(); 
        const idx = parseInt(btn.getAttribute('data-level'),10);
        if (Number.isNaN(idx)) return;

        if(window.__GAME__ && window.__GAME__.setSelectedLevel){
          window.__GAME__.setSelectedLevel(idx);
        }
        const L = (window.__GAME__ && window.__GAME__.getLevel) ? window.__GAME__.getLevel(idx) : null;
        startTitle.textContent = ((L && L.mission) ? L.mission : `ภารกิจ: ${btn.textContent}`);

        landing.classList.add('hide');
        startScreen.style.display = 'flex';
        const startBtn = document.getElementById('startBtn');
        if(startBtn){ startBtn.style.display = 'inline-block'; }
        const countdownEl = document.getElementById('countdown');
        if(countdownEl){ countdownEl.style.display = 'none'; }
      });
    });

    const guideBtn  = document.getElementById('guideBtn');
    const guide     = document.getElementById('guideScreen');
    const guideBack = document.getElementById('guideBack');

    if (guideBtn && guide){
      guideBtn.addEventListener('click', ()=>{
        landing.classList.add('hide');
        guide.style.display = 'flex';
      });
    }
    if (guideBack && guide){
      guideBack.addEventListener('click', ()=>{
        guide.style.display = 'none';
        landing.classList.remove('hide');
      });
    }
  })();

})();
</script>

<!-- ===== คำสั่งเสียง ===== -->
<script>
(function(){
  const micBtn   = document.getElementById('micBtn');
  const voicePill= document.getElementById('voicePill');
  if(!micBtn) return;

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    micBtn.textContent = '🎤 ไม่รองรับ';
    micBtn.disabled = true;
    return;
  }

  let askedOnce = false;
  let keepListening = false;
  let recognizing = false;

  const rec = new SR();
  rec.lang = 'th-TH';
  rec.continuous = true;
  rec.interimResults = true;

  function showListening(on){
    micBtn.textContent = on ? '🎤 เสียง: เปิด' : '🎤 เสียง: ปิด';
    if(voicePill) voicePill.style.display = on ? 'inline-block' : 'none';
  }

  function tokensFrom(s){
    s = (s||'').toLowerCase().trim();
    s = s.replace(/\s*(ค่ะ|ครับ|คะ|ฮะ)$/,'');
    return s.split(/[\s,，。\.!?:;、]+/).filter(Boolean);
  }

  function currentCometsMap(){
    const map = new Map();
    document.querySelectorAll('.comet').forEach(n=>{
      const label = (n.querySelector('.label')?.textContent||'').trim().toLowerCase();
      if(!label) return;
      if(!map.has(label)) map.set(label, []);
      map.get(label).push(n);
    });
    return map;
  }
  function pickLowest(arr){
    return arr.reduce((best,n)=>{
      const y = parseFloat(n.dataset.y)||0;
      return (!best || y > (parseFloat(best.dataset.y)||0)) ? n : best;
    }, null);
  }
  function centerOf(node){
    const r = node.getBoundingClientRect();
    return { x: r.left + r.width/2, y: r.top + r.height/2 };
  }

  function tryFire(phrase){
    const toks = tokensFrom(phrase);
    if(!toks.length) return false;

    const cmap = currentCometsMap();
    for(const t of toks){
      if(cmap.has(t)){
        const node = pickLowest(cmap.get(t));
        if(node && !node.dataset.hit){
          const c = centerOf(node);
          window.__GAME__?.hitComet(node, c.x, c.y);
          return true;
        }
      }
    }
    return false;
  }

  rec.onresult = (e) => {
    for(let i=e.resultIndex; i<e.results.length; i++){
      const r = e.results[i];
      const txt = (r[0]?.transcript || '').trim();
      if(!txt) continue;
      tryFire(txt);
    }
  };
  rec.onstart = () => { recognizing = true; showListening(true); };
  rec.onend   = () => {
    recognizing = false; showListening(false);
    if(keepListening && !document.hidden){
      setTimeout(()=>{ try{ rec.start(); }catch(_){} }, 200);
    }
  };
  rec.onerror = (e) => {
    if(e?.error === 'not-allowed'){
      micBtn.textContent = '🎤 ไม่ได้รับอนุญาต';
      micBtn.disabled = true;
    }
  };

  async function ensureMicPermissionOnce(){
    if(askedOnce) return;
    askedOnce = true;
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      stream.getTracks().forEach(t=>t.stop());
    }catch(_){
      micBtn.textContent = '🎤 ไม่ได้รับอนุญาต';
      micBtn.disabled = true;
      throw _;
    }
  }

  function startListen(){
    keepListening = true;
    try{ rec.start(); }catch(_){}
  }
  function stopListen(){
    keepListening = false;
    try{ rec.stop(); }catch(_){}
  }

  micBtn.addEventListener('click', async ()=>{
    if(keepListening){ stopListen(); return; }
    try{
      await ensureMicPermissionOnce();
      startListen();
    }catch(_){}
  });

  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){
      if(recognizing) try{ rec.stop(); }catch(_){}
    }else if(keepListening){
      setTimeout(()=>{ try{ rec.start(); }catch(_){ } }, 150);
    }
  });
})();
</script>

<!-- ===== Pose (ซ่อนโครงก้างปลา) + หัวกลม + วงกลมปลายแขนชนได้เท่านั้น ===== -->
<script type="module">
import {PoseLandmarker, FilesetResolver} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

const camBtn = document.getElementById('camBtn');
const video  = document.getElementById('cameraMirror');
const cvs    = document.getElementById('camCanvas');
const ctx    = cvs.getContext('2d', { alpha: true });
const shipEl = document.getElementById('ship');
// ===== Downscale สำหรับโมเดล =====
const DETECT_W = 320;   // กำหนดความกว้างอินพุตของโมเดล (ประมาณ 240–360 ก็กำลังดี)
let detectCanvas = document.createElement('canvas');
let detectCtx = detectCanvas.getContext('2d', { alpha:false, desynchronized:true });
let lastPose = null;

// ปรับ ctx ของแคนวาสหลักให้ desynchronized เพื่อลดสั่นไหว/ลด jank เล็กน้อย
// (ทับบรรทัดเดิมที่สร้าง ctx ถ้ายังไม่ได้ใส่)

// === Perf toggle: ลดความละเอียดแคนวาสตอนเปิดกล้อง ===
let CAM_ON = false;   // true เมื่อเปิดกล้อง AR


function fitCanvas(){
  // ถ้ากล้อง AR เปิด: บังคับ dpr=1 เพื่อลดงานวาด/เมม
  // ถ้าปิด: ใช้ dpr จริงของจอเพื่อความคมชัด
  const dpr = CAM_ON ? 1 : Math.max(1, window.devicePixelRatio || 1);

  cvs.width  = Math.round(window.innerWidth  * dpr);
  cvs.height = Math.round(window.innerHeight * dpr);
  cvs.style.width  = window.innerWidth + 'px';
  cvs.style.height = window.innerHeight + 'px';

  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);
}

fitCanvas();
window.addEventListener('resize', fitCanvas);

function scr(){ return {w: window.innerWidth, h: window.innerHeight}; }

function coverCropRect(){
  const vw = video.videoWidth || 640;
  const vh = video.videoHeight || 480;
  const {w:sw, h:sh} = scr();
  const scale = Math.max(sw / vw, sh / vh);
  const sW = Math.round(sw / scale);
  const sH = Math.round(sh / scale);
  const sX = Math.round((vw - sW) / 2);
  const sY = Math.round((vh - sH) / 2);
  return { sX, sY, sW, sH, vw, vh, sw, sh };
}

function mapToScreen(nx, ny){
  const {sX,sY,sW,sH, vw, vh, sw, sh} = coverCropRect();
  const px = nx * vw;
  const py = ny * vh;
  const u = (px - sX) / sW;
  const v = (py - sY) / sH;
  let x = u * sw;
  let y = v * sh;
  x = sw - x; // mirror
  return {x, y};
}

function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

const lastHitAt = new WeakMap();
const HIT_LOCK_MS = 160;
// === Hand trails (Fruit-Ninja style) ===
const TRAIL_KEEP_MS = 220;       // อายุรอย (ms)
const TRAIL_SAMPLE_MIN_DIST = 8; // ต้องขยับอย่างน้อยกี่ px ถึงจะเก็บจุด
const TRAIL_MAX_POINTS = 40;     // จำกัดจำนวนจุดในรอย
// === แสดง/ซ่อนวงกลมที่มือ ===
const SHOW_HAND_BALL = false; // false = ซ่อน (ยังชนได้)


const leftTrail  = [];
const rightTrail = [];


function circleIntersectsRect(cx, cy, r, rc){
  const nx = Math.max(rc.left, Math.min(cx, rc.right));
  const ny = Math.max(rc.top,  Math.min(cy, rc.bottom));
  const dx = cx - nx, dy = cy - ny;
  return (dx*dx + dy*dy) <= r*r;
}

function pushTrail(trail, p){
  if(!p) return;
  const t = performance.now();
  const last = trail[trail.length-1];
  if(!last || Math.hypot(p.x-last.x, p.y-last.y) >= TRAIL_SAMPLE_MIN_DIST){
    trail.push({x:p.x, y:p.y, t});
    if(trail.length > TRAIL_MAX_POINTS) trail.shift();
  }else{
    // ถ้าเคลื่อนน้อย ให้ยืดอายุจุดท้ายแทน
    last.t = t;
  }
  // ล้างจุดที่หมดอายุ
  const cutoff = t - TRAIL_KEEP_MS;
  while(trail.length && trail[0].t < cutoff) trail.shift();
}

function drawTrail(trail){
  if(trail.length < 2) return;
  const now = performance.now();
  ctx.save();
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  // วาดให้อยู่ "ใต้" วงกลมมือ (แม้จะเรียกทีหลัง)
  ctx.globalCompositeOperation = 'destination-over';

  for(let i=1;i<trail.length;i++){
    const a = trail[i-1], b = trail[i];
    const age = now - b.t;
    const alpha = 1 - (age / TRAIL_KEEP_MS);
    if(alpha <= 0) continue;

    const w = 16 * alpha + 6; // หนาใกล้ปัจจุบัน บางเมื่อเก่า
    ctx.shadowColor = `rgba(255,255,255,${0.9*alpha})`;
    ctx.shadowBlur  = 14 * alpha;
    ctx.strokeStyle = `rgba(255,255,255,${0.85*alpha})`;
    ctx.lineWidth   = w;

    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.stroke();
  }
  ctx.restore();
}


function hitByCircle(center, radius){
  const comets = Array.from(document.querySelectorAll('.comet')).filter(n=>!n.dataset.hit);
  if(!comets.length) return;
  for(const node of comets){
    const r = node.getBoundingClientRect();
    if(circleIntersectsRect(center.x, center.y, radius, r)){
      const t = performance.now();
      const last = lastHitAt.get(node) || 0;
      if (t - last < HIT_LOCK_MS) continue;
      lastHitAt.set(node, t);
      try{ window.__GAME__?.hitComet(node, center.x, center.y); }catch(e){}
    }
  }
}

let landmarker = null;
let raf = 0;
let stream = null;

async function ensureLandmarker(){
  if(landmarker) return landmarker;
  const fileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
  landmarker = await PoseLandmarker.createFromOptions(fileset, {
    baseOptions: {
      modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"
    },
    runningMode: 'VIDEO',
    numPoses: 1,
    minPoseDetectionConfidence: 0.35,
    minPosePresenceConfidence: 0.35,
    minTrackingConfidence: 0.35
  });
  return landmarker;
}

function drawPoseAndColliders(results){
  const {w:sw, h:sh} = scr();
  ctx.clearRect(0,0,sw,sh);

  if(!results?.landmarks?.length) return;
  const lm = results.landmarks[0];
  const P = (i)=> mapToScreen(lm[i].x, lm[i].y);

  // ===== วงกลมปลายแขน (ชนได้เท่านั้น) — คงที่: 1/3 ของหัว =====
function armBall(elbowIdx, wristIdx){
  if(!lm[elbowIdx] || !lm[wristIdx]) return null;
  const elbow = P(elbowIdx);
  const wrist = P(wristIdx);

  // ใช้ rHead จากด้านบน: เล็กกว่าหัว 3 เท่า (คงที่ตามสัดส่วนหัว)
  const r = 24;

  // หาทิศทางศอก→ข้อมือ เพื่อดันจุดศูนย์กลางออกไปนอกข้อมือเล็กน้อย
  const L  = Math.max(1, dist(elbow, wrist));
  const ux = (wrist.x - elbow.x) / L;
  const uy = (wrist.y - elbow.y) / L;
  // ดันวงกลมออกจากข้อมือมากขึ้น (ปรับได้สองปุ่ม: สัดส่วน + ระยะคงที่)
const HAND_PUSH = 1.5; // 1.0–1.3 ยิ่งมากยิ่งไกล (เดิม 0.55*r)
const PUSH_PX   = 6;    // 0–8 px บวกเพิ่มคงที่
const center = {
  x: wrist.x + ux * (r * HAND_PUSH + PUSH_PX),
  y: wrist.y + uy * (r * HAND_PUSH + PUSH_PX)
};

// วาด (ถ้าเปิดใช้งาน) — ปกติเราปิดไว้เพื่อซ่อนวง
if (SHOW_HAND_BALL) {
  ctx.beginPath();
  ctx.arc(center.x, center.y, r, 0, Math.PI*2);

  // ขาวทั้งวง + เรืองแสงขาวนิดๆ (เหมือนของเดิม)
  ctx.shadowColor = 'rgba(255,255,255,0.9)';
  ctx.shadowBlur  = 10;
  ctx.fillStyle   = '#ffffff';
  ctx.fill();
  ctx.lineWidth   = 3;
  ctx.strokeStyle = '#ffffff';
  ctx.stroke();
  ctx.shadowBlur = 0;
}


  // ชนคอมเม็ต
  hitByCircle(center, r * 0.95);
  return center;
}

  const cL = armBall(13,15);  // วาดวงซ้าย + ชนคอมเม็ต
const cR = armBall(14,16);  // วาดวงขวา + ชนคอมเม็ต

  // *** ไม่วาด "โครงก้างปลา" แล้ว (เส้นโครงทั้งตัวถูกซ่อน) ***
}

function runLoop(){
  const step = () => {
    if(!video.videoWidth){ raf = requestAnimationFrame(step); return; }
    const now = performance.now();
    try{
      // ครอปจากเฟรมกล้องให้เหมือน object-fit: cover แล้วย่อเข้า detectCanvas
const {sX,sY,sW,sH} = coverCropRect();
detectCtx.drawImage(video, sX, sY, sW, sH, 0, 0, detectCanvas.width, detectCanvas.height);

// ส่งเข้าโมเดลด้วยภาพที่ลดขนาดแล้ว
const res = landmarker.detectForVideo(detectCanvas, now);
lastPose = res;

drawPoseAndColliders(res);
    }catch(e){}
    raf = requestAnimationFrame(step);
  };
  raf = requestAnimationFrame(step);
}

async function startCamera(){
  await ensureLandmarker();
  stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
  video.srcObject = stream;
  await video.play().catch(()=>{});
// เซ็ตขนาดอินพุตของโมเดลให้เล็กลง แต่รักษาอัตราส่วนภาพจากกล้อง
const vw = video.videoWidth || 640, vh = video.videoHeight || 480;
const ratio = vw / vh;
detectCanvas.width  = DETECT_W;
detectCanvas.height = Math.round(DETECT_W / ratio);
  video.style.display = 'block';
  cvs.style.display   = 'block';
  camBtn.textContent  = '📷 กล้อง: เปิด';
if (shipEl) shipEl.style.display = 'none';
CAM_ON = true;
fitCanvas();
runLoop();
}

function stopCamera(){
  cancelAnimationFrame(raf);
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
  try{ video.pause(); }catch(e){}
  video.removeAttribute('srcObject');
  video.style.display = 'none';
  cvs.style.display   = 'none';
  ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
  camBtn.textContent  = '📷 กล้อง: ปิด';
if (shipEl) shipEl.style.display = '';
CAM_ON = false;   // คืนความคมชัดแคนวาสเมื่อปิดกล้อง
fitCanvas();
}

camBtn.addEventListener('click', async ()=>{
  window.__AUDIO__?.unlock?.();
  if(!stream){
    try{ await startCamera(); }
    catch(err){ camBtn.textContent = '📷 กล้อง: ไม่ได้รับอนุญาต'; camBtn.disabled = true; }
  }else{
    stopCamera();
  }
});

document.addEventListener('visibilitychange', ()=>{ if(document.hidden && stream) stopCamera(); });
</script>

</body>
</html>


